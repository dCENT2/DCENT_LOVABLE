<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>dCent Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    .box { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    input, select { margin: 5px; padding: 5px; }
    pre { background: #f8f8f8; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>dCent Demo</h1>

  <!-- Identitäten -->
  <div class="box">
    <h3>Identität</h3>
    <input id="peerName" placeholder="Peer-Name (z.B. alice)" />
    <button onclick="createIdentity()">Neue Identität erzeugen</button>
    <button onclick="showKeys()">Alle Keys anzeigen</button>
    <pre id="keysOutput"></pre>
  </div>

  <!-- Verträge -->
  <div class="box">
    <h3>Vertrag</h3>
    <label>Von:</label>
    <select id="fromPeer"></select>
    <label>Zu:</label>
    <select id="toPeer"></select><br/>
    <input id="contractText" placeholder="Vertragsinhalt" />
    <input id="amount" placeholder="Betrag" type="number" />
    <button onclick="createContractUI()">Vertrag anlegen</button>
    <button onclick="showContracts()">Alle Verträge anzeigen</button>
    <pre id="contractsOutput"></pre>
  </div>

  <!-- TrustScores -->
  <div class="box">
    <h3>TrustScores</h3>
    <button onclick="showTrustScores()">TrustScores berechnen</button>
    <pre id="trustOutput"></pre>
  </div>

  <!-- Entschlüsselung -->
  <div class="box">
    <h3>Vertrag entschlüsseln</h3>
    <label>Peer:</label>
    <select id="decryptPeer"></select>
    <button onclick="decryptFirst()">Ersten Vertrag entschlüsseln</button>
    <pre id="decryptOutput"></pre>
  </div>

  <!-- Signaturprüfung -->
  <div class="box">
    <h3>Signatur prüfen</h3>
    <button onclick="verifyFirstContract()">Signatur vom ersten Vertrag prüfen</button>
    <pre id="verifyOutput"></pre>
  </div>

  <script type="module">
    import { createKeyPair, listKeys, formatPeerLabel } from "./core/keyManager.js";
    import { createContract, listContracts, decryptContract, verifyContractSignature } from "./core/contractManager.js";
    import { calculateTrustScores } from "./core/trustGraph.js";

    // Dropdowns aktualisieren
    async function refreshPeerDropdowns() {
      const peers = await listKeys();
      const fromSelect = document.getElementById("fromPeer");
      const toSelect = document.getElementById("toPeer");
      const decryptSelect = document.getElementById("decryptPeer");

      [fromSelect, toSelect, decryptSelect].forEach(sel => sel.innerHTML = "");

      peers.forEach(peer => {
        const option = document.createElement("option");
        option.value = peer.id;                // volle Peer-ID als Value
        option.text = formatPeerLabel(peer);   // Name [ShortID] als Anzeige
        fromSelect.appendChild(option.cloneNode(true));
        toSelect.appendChild(option.cloneNode(true));
        decryptSelect.appendChild(option.cloneNode(true));
      });
    }

    // Identität erzeugen
    window.createIdentity = async () => {
      const name = document.getElementById("peerName").value.trim();
      if (!name) return alert("Bitte einen Namen eingeben!");
      const peer = await createKeyPair(name);
      alert("Identität erstellt: " + formatPeerLabel(peer));
      await refreshPeerDropdowns();
    };

    // Keys anzeigen
    window.showKeys = async () => {
      const keys = await listKeys();
      document.getElementById("keysOutput").innerText = JSON.stringify(keys, null, 2);
    };

    // Vertrag anlegen
    window.createContractUI = async () => {
      const from = document.getElementById("fromPeer").value;
      const to = document.getElementById("toPeer").value;
      const text = document.getElementById("contractText").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      if (!from || !to || !text) return alert("Alle Felder ausfüllen!");
      const ctr = await createContract(from, to, text, amount);
      alert("Vertrag erstellt: " + ctr.id);
    };

    // Verträge anzeigen
    window.showContracts = async () => {
      const ctrs = await listContracts();
      document.getElementById("contractsOutput").innerText = JSON.stringify(ctrs, null, 2);
    };

    // TrustScores berechnen
    window.showTrustScores = async () => {
      const scores = await calculateTrustScores();
      document.getElementById("trustOutput").innerText = JSON.stringify(scores, null, 2);
    };

    // Vertrag entschlüsseln
    window.decryptFirst = async () => {
      const peerId = document.getElementById("decryptPeer").value;
      if (!peerId) return alert("Kein Peer ausgewählt!");
      const ctrs = await listContracts();
      if (ctrs.length === 0) return alert("Keine Verträge gefunden");
      try {
        const plain = await decryptContract(ctrs[0], peerId);
        document.getElementById("decryptOutput").innerText = JSON.stringify(plain, null, 2);
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    };

    // Signatur prüfen
    window.verifyFirstContract = async () => {
      const ctrs = await listContracts();
      if (ctrs.length === 0) return alert("Keine Verträge gefunden");
      try {
        const ok = await verifyContractSignature(ctrs[0]);
        document.getElementById("verifyOutput").innerText = ok ? "✅ Signatur gültig" : "❌ Signatur ungültig";
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    };

    // Dropdowns initial laden
    refreshPeerDropdowns();
  </script>
</body>
</html>
