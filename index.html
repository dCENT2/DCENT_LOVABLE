// dCent Core – TrustGraph (Whitepaper-konform mit Collateral-Kurven-Dehnung & Strafe für gebrochene Verträge)

import { listContracts } from "./contractManager.js";

// Parameter
const MAX_TRUST = 100;   // Score immer <= 100
const K = 0.1;           // Basis-Steigung
const ALPHA = 0.05;      // Collateral-Faktor (logarithmische Dehnung)
const BETA = 0.2;        // Diversitäts-Faktor
const GAMMA = 0.2;       // Straf-Faktor pro gebrochenem Vertrag (20 % Abzug)

// Asymptotisches Wachstum mit Collateral-Dehnung
function baseTrust(n, totalCollateral) {
  const fCollateral = ALPHA * Math.log(1 + totalCollateral); // Dehnung durch Pfand
  const effectiveK = K + fCollateral;
  return MAX_TRUST * (1 - Math.exp(-effectiveK * n));
}

export async function calculateTrustScores() {
  const contracts = await listContracts();
  const peerContracts = {};

  // Verträge pro Peer sammeln
  contracts.forEach(contract => {
    [contract.from, contract.to].forEach(peer => {
      if (!peerContracts[peer]) peerContracts[peer] = [];
      peerContracts[peer].push(contract);
    });
  });

  const scores = {};
  const details = {};

  for (const peer in peerContracts) {
    const contracts = peerContracts[peer];

    // Zählen
    const fulfilled = contracts.filter(c => c.status === "active").length;
    const broken = contracts.filter(c => c.status === "broken").length;

    // Diversität
    const partners = new Set();
    contracts.forEach(c => {
      if (c.status === "active") {
        partners.add(c.from === peer ? c.to : c.from);
      }
    });
    const d = partners.size;

    // Collateral
    let totalCollateral = 0;
    contracts.forEach(c => {
      if (c.status === "active" && c.collateral) {
        if (c.from === peer) totalCollateral += c.collateral.from || 0;
        if (c.to === peer) totalCollateral += c.collateral.to || 0;
      }
    });

    // Basiswert
    const base = baseTrust(fulfilled, totalCollateral);

    // Diversitätsbonus
    let score = base * (1 + BETA * (d / Math.max(1, fulfilled)));

    // Strafe für gebrochene Verträge
    if (broken > 0) {
      const penalty = GAMMA * broken * score;
      score -= penalty;
    }

    // Grenzen
    if (score < 0) score = 0;
    if (score > MAX_TRUST) score = MAX_TRUST;

    scores[peer] = Math.round(score);
    details[peer] = {
      fulfilled,
      broken,
      d,
      totalCollateral,
      base: Math.round(base)
    };
  }

  return { scores, details };
}

export async function getTrustScore(peerId) {
  const { scores } = await calculateTrustScores();
  return scores[peerId] || 0;
}
