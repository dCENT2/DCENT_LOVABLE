<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>dCent Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    .box { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    input, select, textarea { margin: 5px; padding: 5px; }
    pre { background: #f8f8f8; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>dCent Demo</h1>

  <!-- Identitäten -->
  <div class="box">
    <h3>Identität</h3>
    <input id="peerName" placeholder="Peer-Name (z.B. alice)" />
    <button onclick="createIdentity()">Neue Identität erzeugen</button>
    <button onclick="showKeys()">Alle Keys anzeigen</button>
    <pre id="keysOutput"></pre>
  </div>

  <!-- Collateral Wallet -->
  <div class="box">
    <h3>Collateral Wallets</h3>
    <button onclick="showWallets()">Alle Wallets anzeigen</button><br/>
    <label>Peer:</label>
    <select id="walletPeer"></select>
    <label>Betrag:</label>
    <input id="walletAmount" type="number" value="100" />
    <button onclick="fundWallet()">Aufladen (Test)</button>
    <pre id="walletOutput"></pre>
  </div>

  <!-- Normaler Vertrag -->
  <div class="box">
    <h3>Vertrag (einfach)</h3>
    <label>Von:</label>
    <select id="fromPeer"></select>
    <label>Zu:</label>
    <select id="toPeer"></select><br/>
    <input id="contractText" placeholder="Vertragsinhalt" />
    <input id="amount" placeholder="Betrag" type="number" />
    <input id="collateral" placeholder="Pfand (DZP)" type="number" />
    <button onclick="createContractUI()">Vertrag anlegen (pending)</button>
    <button onclick="showContracts()">Alle Verträge anzeigen</button>
    <pre id="contractsOutput"></pre>
  </div>

  <!-- Vertrags-Status ändern -->
  <div class="box">
    <h3>Vertrags-Status ändern</h3>
    <input id="contractId" placeholder="Contract-ID" />
    <label>Peer:</label>
    <select id="statusPeer"></select>
    <label>Status:</label>
    <select id="newStatus">
      <option value="active">active</option>
      <option value="broken">broken</option>
    </select>
    <button onclick="setStatusUI()">Status setzen</button>
    <pre id="statusOutput"></pre>
    <pre id="collateralStatusOutput"></pre>
  </div>

  <!-- Multisig-Verträge -->
  <div class="box">
    <h3>Multisig-Verträge</h3>
    <label>Teilnehmer (IDs, Komma-getrennt):</label><br/>
    <textarea id="multiParticipants" rows="2" cols="60"></textarea><br/>
    <label>Threshold:</label>
    <input id="multiThreshold" type="number" value="2" />
    <input id="multiText" placeholder="Vertragsinhalt" />
    <input id="multiAmount" placeholder="Betrag" type="number" />
    <button onclick="createMultisigUI()">Multisig-Vertrag anlegen</button>
    <button onclick="showMultisig()">Alle Multisig-Verträge anzeigen</button>
    <pre id="multisigOutput"></pre>

    <h4>Multisig-Vertrag unterschreiben</h4>
    <label>Contract-ID:</label>
    <input id="multiSignId" />
    <label>Signer:</label>
    <select id="multiSigner"></select>
    <button onclick="signMultisigUI()">Signieren</button>
    <pre id="multiSignOutput"></pre>
  </div>

  <!-- TrustScores -->
  <div class="box">
    <h3>TrustScores (Whitepaper-Modell)</h3>
    <button onclick="showTrustScores()">TrustScores berechnen</button>
    <pre id="trustOutput"></pre>
  </div>

  <!-- Backup / Restore -->
  <div class="box">
    <h3>Backup / Restore</h3>
    <button onclick="downloadBackup()">Backup herunterladen</button><br/>
    <input type="file" id="backupFile" />
    <button onclick="restoreBackup()">Backup wiederherstellen</button>
    <pre id="backupOutput"></pre>
  </div>

  <script type="module">
    import { createKeyPair, listKeys, formatPeerLabel } from "./core/keyManager.js";
    import { createContract, listContracts, setContractStatus } from "./core/contractManager.js";
    import { calculateTrustScores } from "./core/trustGraph.js";
    import { downloadBackup, uploadBackup, getAllFromDB } from "./core/storage.js";
    import { createMultisigContract, listMultisigContracts, signContract } from "./core/multisigManager.js";
    import { addCollateral, getCollateral } from "./core/collateralManager.js";

    // Dropdowns aktualisieren
    async function refreshPeerDropdowns() {
      const peers = await listKeys();
      const fromSelect = document.getElementById("fromPeer");
      const toSelect = document.getElementById("toPeer");
      const multiSigner = document.getElementById("multiSigner");
      const statusPeer = document.getElementById("statusPeer");
      const walletPeer = document.getElementById("walletPeer");

      [fromSelect, toSelect, multiSigner, statusPeer, walletPeer].forEach(sel => sel.innerHTML = "");

      peers.forEach(peer => {
        const option = document.createElement("option");
        option.value = peer.id;
        option.text = formatPeerLabel(peer);
        fromSelect.appendChild(option.cloneNode(true));
        toSelect.appendChild(option.cloneNode(true));
        multiSigner.appendChild(option.cloneNode(true));
        statusPeer.appendChild(option.cloneNode(true));
        walletPeer.appendChild(option.cloneNode(true));
      });
    }

    // Identität
    window.createIdentity = async () => {
      const name = document.getElementById("peerName").value.trim();
      if (!name) return alert("Bitte Namen eingeben!");
      const peer = await createKeyPair(name);
      alert("Identität erstellt: " + formatPeerLabel(peer));
      await refreshPeerDropdowns();
    };
    window.showKeys = async () => {
      const keys = await listKeys();
      document.getElementById("keysOutput").innerText = JSON.stringify(keys, null, 2);
    };

    // Wallets
    window.showWallets = async () => {
      const wallets = await getAllFromDB("collateral");
      document.getElementById("walletOutput").innerText = JSON.stringify(wallets, null, 2);
    };
    window.fundWallet = async () => {
      const peerId = document.getElementById("walletPeer").value;
      const amount = parseFloat(document.getElementById("walletAmount").value) || 0;
      if (!peerId || amount <= 0) return alert("Bitte gültige Daten eingeben");
      await addCollateral(peerId, amount);
      const balance = await getCollateral(peerId);
      alert(`Wallet von ${peerId} aufgeladen. Neuer Stand: ${balance}`);
      await window.showWallets();
    };

    // Normaler Vertrag
    window.createContractUI = async () => {
      const from = document.getElementById("fromPeer").value;
      const to = document.getElementById("toPeer").value;
      const text = document.getElementById("contractText").value.trim();
      const amount = parseFloat(document.getElementById("amount").value) || 0;

      const collateralInput = document.getElementById("collateral").value;
      let collateral = 0;
      if (collateralInput && !isNaN(parseFloat(collateralInput))) {
        collateral = parseFloat(collateralInput);
      }

      const ctr = await createContract(from, to, text, amount, collateral);
      alert("Vertrag erstellt (pending) mit ID: " + ctr.id);
    };

    window.showContracts = async () => {
      const ctrs = await listContracts();
      document.getElementById("contractsOutput").innerText = JSON.stringify(ctrs, null, 2);
    };

    // Vertragsstatus ändern + Collateral-Anzeige
    window.setStatusUI = async () => {
      const id = document.getElementById("contractId").value.trim();
      const peerId = document.getElementById("statusPeer").value;
      const status = document.getElementById("newStatus").value;
      try {
        const ctr = await setContractStatus(id, peerId, status);
        document.getElementById("statusOutput").innerText = JSON.stringify(ctr, null, 2);

        if (ctr.collateral) {
          document.getElementById("collateralStatusOutput").innerText =
            `Collateral Status: ${ctr.collateral.status}, Betrag: ${ctr.collateral.to || ctr.collateral.from}`;
        } else {
          document.getElementById("collateralStatusOutput").innerText = "Kein Collateral gesetzt.";
        }
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    };

    // Multisig-Verträge
    window.createMultisigUI = async () => {
      const participantsInput = document.getElementById("multiParticipants").value.trim();
      const participants = participantsInput.split(",").map(s => s.trim()).filter(s => s.length > 0);
      const threshold = parseInt(document.getElementById("multiThreshold").value) || 1;
      const text = document.getElementById("multiText").value.trim();
      const amount = parseFloat(document.getElementById("multiAmount").value) || 0;

      try {
        const ctr = await createMultisigContract(participants, threshold, text, amount);
        alert("Multisig-Vertrag erstellt: " + ctr.id);
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    };

    window.showMultisig = async () => {
      const ctrs = await listMultisigContracts();
      let output = "";
      ctrs.forEach(c => {
        output += `ID: ${c.id}\n`;
        output += `  Teilnehmer: ${c.participants.join(", ")}\n`;
        output += `  Threshold: ${c.threshold}/${c.participants.length}\n`;
        output += `  Status: ${c.status}\n`;
        output += `  Signaturen: ${c.signatures ? c.signatures.length : 0}\n`;
        if (c.approvals) {
          output += `  Votes: ${JSON.stringify(c.approvals)}\n`;
        }
        if (c.collateral) {
          output += `  Collateral: ${JSON.stringify(c.collateral)}\n`;
        }
        output += "\n";
      });
      document.getElementById("multisigOutput").innerText = output || "Keine Multisig-Verträge gefunden.";
    };

    window.signMultisigUI = async () => {
      const contractId = document.getElementById("multiSignId").value.trim();
      const signerId = document.getElementById("multiSigner").value;
      try {
        const ctr = await signContract(contractId, signerId);
        document.getElementById("multiSignOutput").innerText = "Signatur gespeichert. Status: " + ctr.status;
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    };

    // TrustScores
    window.showTrustScores = async () => {
      const { scores, details } = await calculateTrustScores();
      let output = "";
      for (const peer in scores) {
        const s = scores[peer];
        const d = details[peer];
        output += `${peer}\n`;
        output += `  Gesamt: ${s}\n`;
        output += `  Erfüllt: ${d.fulfilled}, Gebrochen: ${d.broken}\n`;
        output += `  Diversität: ${d.d}\n`;
        output += `  Collateral gesamt: ${d.totalCollateral}\n`;
        output += `  Basiswert: ${d.base}\n`;
        if (d.multisigBonus !== undefined) {
          output += `  Multisig-Threshold-Bonus: ${d.multisigBonus}\n`;
        }
        output += "\n";
      }
      document.getElementById("trustOutput").innerText =
        output || "Keine Verträge gefunden.";
    };

    // Backup
    window.downloadBackup = async () => { await downloadBackup(); };
    window.restoreBackup = async () => {
      const fileInput = document.getElementById("backupFile");
      if (!fileInput.files.length) return alert("Bitte Datei auswählen!");
      await uploadBackup(fileInput.files[0]);
      await refreshPeerDropdowns();
    };

    refreshPeerDropdowns();
  </script>
</body>
</html>
